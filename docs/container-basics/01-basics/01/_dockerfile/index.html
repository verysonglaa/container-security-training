<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=../../../../../favicons/favicon.ico><link rel=apple-touch-icon href=../../../../../favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=../../../../../favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=../../../../../favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=../../../../../favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=../../../../../favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=../../../../../favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=../../../../../favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=../../../../../favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=../../../../../favicons/android-192x192.png sizes=192x192><title>Dockerfile | Container Security Training</title>
<meta name=description content="Dockerfile Docker builds container images by reading instructions from a &amp;lsquo;Dockerfile&amp;rsquo; or, more broadly, a &amp;lsquo;Containerfile.&amp;rsquo;&amp;quot; The basic docs on how Dockerfiles work can be found at https://docs.docker.com/engine/reference/builder/ .
Write your first Dockerfile Let us have a general look at how to build a container image. For that, create a new directory with an empty Dockerfile in there.
mkdir myfirstimage cd myfirstimage touch Dockerfile Open Dockerfile in your preferred text editor and add the following instructions:"><meta property="og:title" content="Dockerfile"><meta property="og:description" content='Dockerfile Docker builds container images by reading instructions from a &lsquo;Dockerfile&rsquo; or, more broadly, a &lsquo;Containerfile.&rsquo;" The basic docs on how Dockerfiles work can be found at https://docs.docker.com/engine/reference/builder/ .
Write your first Dockerfile Let us have a general look at how to build a container image. For that, create a new directory with an empty Dockerfile in there.
mkdir myfirstimage cd myfirstimage touch Dockerfile Open Dockerfile in your preferred text editor and add the following instructions:'><meta property="og:type" content="article"><meta property="og:url" content="/docs/container-basics/01-basics/01/_dockerfile/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-10-31T16:41:06+01:00"><meta itemprop=name content="Dockerfile"><meta itemprop=description content='Dockerfile Docker builds container images by reading instructions from a &lsquo;Dockerfile&rsquo; or, more broadly, a &lsquo;Containerfile.&rsquo;" The basic docs on how Dockerfiles work can be found at https://docs.docker.com/engine/reference/builder/ .
Write your first Dockerfile Let us have a general look at how to build a container image. For that, create a new directory with an empty Dockerfile in there.
mkdir myfirstimage cd myfirstimage touch Dockerfile Open Dockerfile in your preferred text editor and add the following instructions:'><meta itemprop=dateModified content="2024-10-31T16:41:06+01:00"><meta itemprop=wordCount content="1363"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Dockerfile"><meta name=twitter:description content='Dockerfile Docker builds container images by reading instructions from a &lsquo;Dockerfile&rsquo; or, more broadly, a &lsquo;Containerfile.&rsquo;" The basic docs on how Dockerfiles work can be found at https://docs.docker.com/engine/reference/builder/ .
Write your first Dockerfile Let us have a general look at how to build a container image. For that, create a new directory with an empty Dockerfile in there.
mkdir myfirstimage cd myfirstimage touch Dockerfile Open Dockerfile in your preferred text editor and add the following instructions:'><link rel=preload href=../../../../../scss/main.min.adaeead791a8f109b4559b249a7a020bb877ffc11fefeb15be29f9b5a0346557.css as=style><link href=../../../../../scss/main.min.adaeead791a8f109b4559b249a7a020bb877ffc11fefeb15be29f9b5a0346557.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-page><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=../../../../../><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Container Security Training</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=../../../../../setup/><span>Setup</span></a></li><li class=nav-item><a class="nav-link active" href=../../../../../docs/><span>Labs</span></a></li><li class=nav-item><a class=nav-link href=../../../../../slides/><span>Slides</span></a></li><li class=nav-item><a class=nav-link href=https://songlaa.com target=_blank rel=noopener><span>songlaa gmbh</span></a></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=../../../../../offline-search-index.47eb941f99e5e7541c5e9cc32164e933.json data-offline-search-base-href=../../../../../ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=../../../../../offline-search-index.47eb941f99e5e7541c5e9cc32164e933.json data-offline-search-base-href=../../../../../ data-offline-search-max-results=10></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="td-sidebar-nav collapse" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=../../../../../docs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Labs</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docscontainer-basics01-basics-li><a href=../../../../../docs/container-basics/01-basics/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docscontainer-basics01-basics><span>1. Docker Basics</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics01-basics01_images-li><a href=../../../../../docs/container-basics/01-basics/01/_images/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics01-basics01_images><span>1.1. Images</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics01-basics01_env-vars-li><a href=../../../../../docs/container-basics/01-basics/01/_env-vars/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics01-basics01_env-vars><span>1.2. Environment variables</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics01-basics01_frontend-li><a href=../../../../../docs/container-basics/01-basics/01/_frontend/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics01-basics01_frontend><span>1.3. Frontend</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docscontainer-basics01-basics01_dockerfile-li><a href=../../../../../docs/container-basics/01-basics/01/_dockerfile/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics01-basics01_dockerfile><span class=td-sidebar-nav-active-item>1.4. Dockerfile</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics01-basics01_dockerfile_ms-li><a href=../../../../../docs/container-basics/01-basics/01/_dockerfile_ms/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics01-basics01_dockerfile_ms><span>1.5. MultiStage Build</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics01-basics01_deepdive-li><a href=../../../../../docs/container-basics/01-basics/01/_deepdive/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics01-basics01_deepdive><span>1.6. Under the hood</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontainer-basics02-security-li><a href=../../../../../docs/container-basics/02-security/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docscontainer-basics02-security><span>2. 2. Securing Containers</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics02-security02_ssdlc-li><a href=../../../../../docs/container-basics/02-security/02/_ssdlc/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics02-security02_ssdlc><span>2.1. SSDLC</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics02-security02_trust-li><a href=../../../../../docs/container-basics/02-security/02/_trust/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics02-security02_trust><span>2.2. Docker Trust</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics02-security02_root-li><a href=../../../../../docs/container-basics/02-security/02/_root/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics02-security02_root><span>2.3. Avoid Root</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics02-security02_capabilities-li><a href=../../../../../docs/container-basics/02-security/02/_capabilities/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics02-security02_capabilities><span>2.4. Capabilities</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics02-security02_volumes-li><a href=../../../../../docs/container-basics/02-security/02/_volumes/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics02-security02_volumes><span>2.5. Volume security</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics02-security02_lsm-li><a href=../../../../../docs/container-basics/02-security/02/_lsm/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics02-security02_lsm><span>2.6. Linux Security Modules</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics02-security02_runtime_sec-li><a href=../../../../../docs/container-basics/02-security/02/_runtime_sec/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics02-security02_runtime_sec><span>2.7. Container Runtime Security</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics02-security02_privileged-mode-li><a href=../../../../../docs/container-basics/02-security/02/_privileged-mode/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics02-security02_privileged-mode><span>2.8. Privileged Containers</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontainer-basics02-security02_recap-li><a href=../../../../../docs/container-basics/02-security/02/_recap/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontainer-basics02-security02_recap><span>2.9. Recap</span></a></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/verysonglaa/k8s-security-training-website/tree/main/content/en/docs/container-basics/01-Basics/01/_dockerfile.md class="td-page-meta--view td-page-meta__view" target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/verysonglaa/k8s-security-training-website/edit/main/content/en/docs/container-basics/01-Basics/01/_dockerfile.md class="td-page-meta--edit td-page-meta__edit" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/verysonglaa/k8s-security-training-website/new/main/content/en/docs/container-basics/01-Basics/01?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class="td-page-meta--child td-page-meta__child" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/verysonglaa/k8s-security-training-website/issues/new?title=Dockerfile" class="td-page-meta--issue td-page-meta__issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#dockerfile>Dockerfile</a></li><li><a href=#write-your-first-dockerfile>Write your first Dockerfile</a></li><li><a href=#build-the-image>Build the image</a><ul><li><a href=#what-happens-when-we-build-the-image>What happens when we build the image</a></li><li><a href=#first-sending-the-build-context-to-docker>First: sending the build context to Docker</a></li><li><a href=#second-building-step-execution>Second: building step execution</a></li><li><a href=#the-caching-system>The caching system</a></li><li><a href=#run-it>Run it</a></li></ul></li><li><a href=#the-cmd-instruction-in-dockerfile>The CMD instruction in Dockerfile</a></li><li><a href=#frontend-app-image-build>Frontend app image build</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=../../../../../docs/>Labs</a></li><li class=breadcrumb-item><a href=../../../../../docs/container-basics/01-basics/>Docker Basics</a></li><li class="breadcrumb-item active" aria-current=page>Dockerfile</li></ol></nav><div class=td-content><h1>1.4. Dockerfile</h1><header class=article-meta></header><h2 id=dockerfile>Dockerfile</h2><p>Docker builds container images by reading instructions from a &lsquo;Dockerfile&rsquo; or, more broadly, a &lsquo;Containerfile.&rsquo;"
The basic docs on how Dockerfiles work can be found at <a href=https://docs.docker.com/engine/reference/builder/ target=_blank rel=noopener>https://docs.docker.com/engine/reference/builder/</a>
.</p><h2 id=write-your-first-dockerfile>Write your first Dockerfile</h2><p>Let us have a general look at how to build a container image.
For that, create a new directory with an empty Dockerfile in there.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir myfirstimage
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> myfirstimage
</span></span><span style=display:flex><span>touch Dockerfile
</span></span></code></pre></div><p>Open Dockerfile in your preferred text editor and add the following instructions:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> ubuntu</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> apt-get update <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    apt-get install -y figlet <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    apt-get clean<span style=color:#a40000>
</span></span></span></code></pre></div><ul><li><code>FROM</code> indicates the base image for our build</li><li>Each <code>RUN</code> line will be executed by Docker during the build</li><li>Our RUN commands must be non-interactive (no input can be provided to Docker during the build)</li><li>Check <a href=https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/ target=_blank rel=noopener>https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/</a>
for further best practices on how to write Dockerfiles.</li></ul><h2 id=build-the-image>Build the image</h2><p>Use the following command to build your image:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t myfirstimage .
</span></span></code></pre></div><ul><li><code>-t</code> indicates the tag to apply to the image</li><li><code>.</code> indicates the location of the build context (which we will talk more about later, but is basically the directory where our Dockerfile is located)</li></ul><p>Please note that the tag can be omitted in most Docker commands and instructions. In that case, the tag defaults to <code>latest</code>. Besides being the default tag there&rsquo;s nothing special about <code>latest</code>. Despite its name, it does not necessarily identify the latest version of an image.<br>Depending on the build system it can point to the last image pushed, to the last image built from some branch, or to some old image. It can even not exist at all.<br>Because of this, you must never use the <code>latest</code> tag in production, always use a specific image version.<br>Also see: <a href=https://medium.com/@mccode/the-misunderstood-docker-tag-latest-af3babfd6375 target=_blank rel=noopener>https://medium.com/@mccode/the-misunderstood-docker-tag-latest-af3babfd6375</a></p><h3 id=what-happens-when-we-build-the-image>What happens when we build the image</h3><p>The output of the Docker build looks similar to this:</p><pre tabindex=0><code>[+] Building 13.3s (6/6) FINISHED                                                                                                                                                                     docker:default
 =&gt; [internal] load build definition from Dockerfile                                                                                                                                                            0.1s
 =&gt; =&gt; transferring dockerfile: 127B                                                                                                                                                                            0.0s
 =&gt; [internal] load metadata for docker.io/library/ubuntu:latest                                                                                                                                                1.4s
 =&gt; [internal] load .dockerignore                                                                                                                                                                               0.1s
 =&gt; =&gt; transferring context: 2B                                                                                                                                                                                 0.0s
 =&gt; [1/2] FROM docker.io/library/ubuntu:latest@sha256:99c35190e22d294cdace2783ac55effc69d32896daaa265f0bbedbcde4fbe3e5                                                                                          3.1s
 =&gt; =&gt; resolve docker.io/library/ubuntu:latest@sha256:99c35190e22d294cdace2783ac55effc69d32896daaa265f0bbedbcde4fbe3e5                                                                                          0.1s
 =&gt; =&gt; sha256:99c35190e22d294cdace2783ac55effc69d32896daaa265f0bbedbcde4fbe3e5 6.69kB / 6.69kB                                                                                                                  0.0s
 =&gt; =&gt; sha256:5d070ad5f7fe63623cbb99b4fc0fd997f5591303d4b03ccce50f403957d0ddc4 424B / 424B                                                                                                                      0.0s
 =&gt; =&gt; sha256:59ab366372d56772eb54e426183435e6b0642152cb449ec7ab52473af8ca6e3f 2.30kB / 2.30kB                                                                                                                  0.0s
 =&gt; =&gt; sha256:ff65ddf9395be21bfe1f320b7705e539ee44c1053034f801b1a3cbbf2d0f4056 29.75MB / 29.75MB                                                                                                                0.9s
 =&gt; =&gt; extracting sha256:ff65ddf9395be21bfe1f320b7705e539ee44c1053034f801b1a3cbbf2d0f4056                                                                                                                       1.7s
 =&gt; [2/2] RUN apt-get update &amp;&amp;     apt-get install -y figlet &amp;&amp;     apt-get clean                                                                                                                              8.1s
 =&gt; exporting to image                                                                                                                                                                                          0.3s 
 =&gt; =&gt; exporting layers                                                                                                                                                                                         0.2s 
 =&gt; =&gt; writing image sha256:9739703b2866e9100738cefc2f5c7cb0b9cd2b005e5770829a7608ca55bdcfb5                                                                                                                    0.0s 
 =&gt; =&gt; naming to docker.io/library/myfirstimage 
</code></pre><h3 id=first-sending-the-build-context-to-docker>First: sending the build context to Docker</h3><pre tabindex=0><code>transferring context:
2B
...
</code></pre><ul><li>The build context is the <code>.</code> directory given to docker build</li><li>It is sent (as an archive) to the Docker daemon by the Docker client</li><li>This allows you to use a remote machine to build using local files</li><li>Be careful (or patient) if that directory is big and your connection is slow</li></ul><h3 id=second-building-step-execution>Second: building step execution</h3><pre tabindex=0><code>...
[1/2] FROM docker.io/library/ubuntu:latest
 =&gt; =&gt; resolve docker.io/library/ubuntu:latest
 =&gt; =&gt; sha256:99c35190e22d294cdace2783ac55effc69d32896daaa265f0bbedbcde4fbe3e5 6.69kB / 6.69kB
 [...]
 =&gt; =&gt; extracting sha256:ff65ddf9395be21bfe1f320b7705e539ee44c1053034f801b1a3cbbf2d0f4056  
[2/2] RUN apt-get update &amp;&amp;     apt-get install -y figlet &amp;&amp;     apt-get clean                                                                                                                              8.1s
 =&gt; exporting to image                                                                                                                                                                                          0.3s 
 =&gt; =&gt; exporting layers                                                                                                                                                                                         0.2s 
 =&gt; =&gt; writing image sha256:9739703b2866e9100738cefc2f5c7cb0b9cd2b005e5770829a7608ca55bdcfb5                                                                                                                    0.0s 
 =&gt; =&gt; naming to docker.io/library/myfirstimage 
</code></pre><p>This output shows the stages involved in building an image from a Dockerfile. Here’s a breakdown of each step:</p><ul><li><p><code>[internal] load build definition from Dockerfile (0.1s)</code>: Docker reads the <code>Dockerfile</code> and loads its contents.</p></li><li><p><code>[internal] load metadata for docker.io/library/ubuntu:latest (1.4s)</code>: Docker fetches metadata for the <code>ubuntu:latest</code> image from Docker Hub to check if it’s up-to-date.</p></li><li><p><code>[internal] load .dockerignore (0.1s)</code>: Docker loads <code>.dockerignore</code> to exclude specific files from the build context.</p></li><li><p><code>[1/2] FROM docker.io/library/ubuntu:latest (3.1s)</code>: Docker starts downloading the <code>ubuntu:latest</code> image with a specific hash <code>sha256:99c35190...</code>.</p><ul><li><code>sha256</code> entries represent different image layers:<ul><li>For example, <code>ff65ddf...</code> is a 29.75 MB layer, which Docker downloads and extracts.</li></ul></li></ul></li><li><p><code>[2/2] RUN apt-get update && apt-get install -y figlet && apt-get clean (8.1s)</code>: Docker executes the <code>RUN</code> command to:</p><ul><li>Update the package list (<code>apt-get update</code>),</li><li>Install the <code>figlet</code> package, and</li><li>Clean up cached package files (<code>apt-get clean</code>) to reduce image size.</li></ul></li><li><p><code>exporting to image (0.3s)</code>: Docker finalizes the build by:</p><ul><li>Exporting the layers,</li><li>Writing the image with identifier <code>sha256:9739703...</code>, and</li><li>Naming the image <code>myfirstimage</code> in the Docker library.</li></ul></li></ul><p>The entire build process took 13.3 seconds, with most time spent downloading layers and installing packages.</p><h3 id=the-caching-system>The caching system</h3><p>If you run the same build again, it will be instantaneous.
Why?</p><ul><li>After each build step, Docker takes a snapshot</li><li>Before executing a step, Docker checks if it has already built the same sequence</li><li>Docker uses the exact strings defined in your Dockerfile:<ul><li><code>RUN apt-get install figlet cowsay</code> is different from</li><li><code>RUN apt-get install cowsay figlet</code></li><li><code>RUN apt-get update</code> is not re-executed when the mirrors are updated</li></ul></li><li>All steps after a modified step are re-executed since the filesystem it&rsquo;s based on may have changed</li></ul><p>You can force a rebuild with docker build &ndash;no-cache &mldr;</p><h3 id=run-it>Run it</h3><p>Now run your image</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -ti myfirstimage
</span></span></code></pre></div><p>You&rsquo;ll find yourself inside a Bash shell in the container, execute</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>figlet hello
</span></span></code></pre></div><p>and you will see the following output:</p><pre tabindex=0><code>root@00f0766080ed:/# figlet hello
 _          _ _
| |__   ___| | | ___
| &#39;_ \ / _ \ | |/ _ \
| | | |  __/ | | (_) |
|_| |_|\___|_|_|\___/

root@00f0766080ed:/#
</code></pre><p>exit the container by executing:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>exit</span>
</span></span></code></pre></div><h2 id=the-cmd-instruction-in-dockerfile>The CMD instruction in Dockerfile</h2><p>With the <code>CMD</code> instruction in the Dockerfile, we can define the command that is executed when a container is started.</p><details><summary>🤔 Can you find out which CMD instruction the ubuntu image uses?</summary><p>You did find yourself in a shell, so the instruction must either be <code>/usr/bin/bash</code> or <code>/usr/bin/sh</code>.</p><p>To find out the CMD instruction of the official Ubuntu image, run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker inspect ubuntu <span style=color:#000;font-weight:700>|</span> grep -A2 CMD
</span></span></code></pre></div><p>You will see the command defined for the ubuntu image. You can also check the Docker Hub page for Ubuntu to see details on what’s included in the image.</p></details><p>Modify the previously created Dockerfile as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> ubuntu</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> apt-get update <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    apt-get install -y figlet <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    apt-get clean<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>CMD</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;figlet&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Build the image with:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t myfirstimagecmd .
</span></span></code></pre></div><p>And run it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -ti myfirstimagecmd
</span></span></code></pre></div><p>It directly executes the defined command and prints out</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> _          _ _
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> <span style=color:#000;font-weight:700>|</span>__   ___<span style=color:#000;font-weight:700>|</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#000;font-weight:700>|</span> ___
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> <span style=color:#a40000>&#39;</span>_ <span style=color:#4e9a06>\ </span>/ _ <span style=color:#4e9a06>\ </span><span style=color:#000;font-weight:700>|</span> <span style=color:#000;font-weight:700>|</span>/ _ <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span><span style=color:#000;font-weight:700>|</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#000;font-weight:700>|</span>  __/ <span style=color:#000;font-weight:700>|</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>(</span>_<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>_<span style=color:#000;font-weight:700>|</span> <span style=color:#000;font-weight:700>|</span>_<span style=color:#000;font-weight:700>|</span><span style=color:#4e9a06>\_</span>__<span style=color:#000;font-weight:700>|</span>_<span style=color:#000;font-weight:700>|</span>_<span style=color:#000;font-weight:700>|</span><span style=color:#4e9a06>\_</span>__/
</span></span></code></pre></div><p>Check out <a href=https://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact target=_blank rel=noopener>https://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact</a>
for more information.</p><h2 id=frontend-app-image-build>Frontend app image build</h2><p>Now we are familiar with the image building process we have a more detailed look at our frontend image. You can find the source code <a href=https://github.com/songlaa/container-lab-fronted target=_blank rel=noopener>here</a>
.</p><p>We see that the developer has become quite lazy and has not updated the python to the latest version, he did not even care to create sensible tags. So let us do it ourselves using the tag <code>v1.0</code></p><p>Check out the repository</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> /home/project
</span></span><span style=display:flex><span>git clone https://github.com/songlaa/container-lab-fronted
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> container-lab-fronted
</span></span></code></pre></div><p>You should have the necessary knowledge now to update and rebuild the image locally. Delete the currently running container and start a new one with updated python.</p><details><summary>😳 I'm lost, show me the solution</summary><p>First of all, we need to check for the latest python base image. You could do this in dockerhub:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>grep FROM Dockerfile
</span></span></code></pre></div><p>We see that currently, we use version 3.9 of python, a look at <a href=https://hub.docker.com/_/python target=_blank rel=noopener>https://hub.docker.com/_/python</a>
shows us that that the most recent version, at the time of writing is 3.12.</p><p>Replace the from line with this new value</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>FROM python:3.12-slim
</span></span></code></pre></div><p>And then we build it using tag <code>v1.0</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t container-lab-frontend:v1.0 .
</span></span><span style=display:flex><span>docker images
</span></span></code></pre></div><p>Finally, we kill the currently running container and start our new one, hopefully we still have $ip saved in our shell:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker stop frontend
</span></span><span style=display:flex><span>docker rm frontend
</span></span><span style=display:flex><span>docker run -d --name frontend -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>peter -e <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>=</span>venkman -e <span style=color:#000>servername</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$ip</span> container-lab-frontend:v1.0
</span></span></code></pre></div></details><details><summary>🤔 What did we update by rebuilding the image?</summary><p>We did not only update python to a recent version but also the modules in python!
Generally, you should <a href=https://docs.docker.com/build/building/best-practices/#rebuild-your-images-often target=_blank rel=noopener>build & deploy often</a>
to avoid configuration drift and keep your software up to date!
A common solution to update your dependencies is <a href=https://docs.renovatebot.com/ target=_blank rel=noopener>https://docs.renovatebot.com/</a></p></details><div class="text-muted mt-5 pt-3"><div class=row><div class=col-sm><a href=../../../../../docs/container-basics/01-basics/01/_frontend/ data-toggle=tooltip title=Frontend><i class="fa fa-arrow-circle-left"></i> Previous</a></div><div class="col-sm text-right"><a href=../../../../../docs/container-basics/01-basics/01/_dockerfile_ms/ data-toggle=tooltip title="MultiStage Build">Next <i class="fa fa-arrow-circle-right"></i></a></div></div></div><div class=td-page-meta__lastmod>Last modified October 31, 2024: <a href=https://github.com/verysonglaa/k8s-security-training-website/commit/f3c664a9190d4cefc70a6effdc5c00a648a3ec09>typos in basic labs, solutions.txt. for recap optional labs (f3c664a)</a></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/verysonglaa/k8s-security-training-website aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2024
<span class=td-footer__authors>songlaa gmbh</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><script src=../../../../../js/main.min.37d14e870feb76f0f7a2a2422bae231efb0186c477999a4ab9ca7e9924ced592.js integrity="sha256-N9FOhw/rdvD3oqJCK64jHvsBhsR3mZpKucp+mSTO1ZI=" crossorigin=anonymous></script><script defer src=../../../../../js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=../../../../../js/tabpane-persist.js></script><script src=../../../../../js/site.min.1b86eee028c038e3c091bb0e4a5f11d864071cfddfac37a5b7d7dc4b7af9bd0a.js integrity="sha256-G4bu4CjAOOPAkbsOSl8R2GQHHP3frDelt9fcS3r5vQo=" crossorigin=anonymous></script></body></html>